worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # --- Rate Limiting Zones ---
    limit_req_zone $binary_remote_addr zone=api:10m rate=100r/m;
    limit_req_zone $binary_remote_addr zone=votes:10m rate=10r/m;
    limit_req_zone $binary_remote_addr zone=sync:10m rate=2r/m;
    limit_req_zone $binary_remote_addr zone=export:10m rate=1r/m;

    # --- Proxy Cache ---
    proxy_cache_path /var/cache/nginx/api levels=1:2
                     keys_zone=api_cache:10m max_size=100m
                     inactive=10m use_temp_path=off;

    # --- Upstreams ---
    upstream go_backend {
        server go-backend:8080;
    }

    upstream python_backend {
        server python-backend:8081;
    }

    # --- Logging ---
    # Access log disabled to avoid logging raw client IPs (PII).
    # Application-level structured logs (Go/Python) hash IPs before logging.
    access_log off;
    error_log  /var/log/nginx/error.log warn;

    # --- Strip Go backend's CORS headers to avoid duplicates ---
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Methods;
    proxy_hide_header Access-Control-Allow-Headers;
    proxy_hide_header Access-Control-Expose-Headers;
    proxy_hide_header Access-Control-Max-Age;

    server {
        listen 80;
        server_name _;

        # --- CORS headers (applied to all responses including NGINX-generated 429s) ---
        # 'always' ensures headers are added even on error responses (429, 5xx, etc.)
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept, X-User-ID" always;
        add_header Access-Control-Expose-Headers "X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset" always;
        add_header Access-Control-Max-Age 86400 always;

        # --- Handle CORS preflight ---
        if ($request_method = OPTIONS) {
            return 204;
        }

        # --- Common proxy settings ---
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 5s;
        proxy_read_timeout 30s;

        # --- Health endpoints (no rate limit, no cache) ---
        location /health/ {
            proxy_pass http://go_backend;
        }

        # --- Vote endpoints: strict rate limit, no cache ---
        location /api/votes {
            limit_req zone=votes burst=5 nodelay;
            limit_req_status 429;
            proxy_pass http://go_backend;
        }

        # --- Sync endpoints: rate limited, selective caching ---
        # NOTE: locations with add_header override server-level add_header,
        #       so CORS headers must be repeated here.
        location /api/sync/full {
            limit_req zone=sync burst=2 nodelay;
            limit_req_status 429;
            proxy_pass http://go_backend;
            proxy_cache api_cache;
            proxy_cache_valid 200 1h;
            add_header X-Cache-Status $upstream_cache_status always;
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept, X-User-ID" always;
            add_header Access-Control-Expose-Headers "X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset" always;
            add_header Access-Control-Max-Age 86400 always;
        }

        location /api/sync/delta {
            limit_req zone=sync burst=2 nodelay;
            limit_req_status 429;
            proxy_pass http://go_backend;
            # No cache - must be fresh
        }

        # --- Stats endpoint: cached 5 minutes ---
        location = /api/stats {
            limit_req zone=api burst=20 nodelay;
            limit_req_status 429;
            proxy_pass http://go_backend;
            proxy_cache api_cache;
            proxy_cache_valid 200 5m;
            add_header X-Cache-Status $upstream_cache_status always;
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept, X-User-ID" always;
            add_header Access-Control-Expose-Headers "X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset" always;
            add_header Access-Control-Max-Age 86400 always;
        }

        # --- Channel endpoints: cached 60 seconds ---
        location /api/channels/ {
            limit_req zone=api burst=20 nodelay;
            limit_req_status 429;
            proxy_pass http://go_backend;
            proxy_cache api_cache;
            proxy_cache_valid 200 60s;
            add_header X-Cache-Status $upstream_cache_status always;
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept, X-User-ID" always;
            add_header Access-Control-Expose-Headers "X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset" always;
            add_header Access-Control-Max-Age 86400 always;
        }

        # --- Video endpoints: cached 5 seconds (high traffic) ---
        # Higher burst to handle extension scanning many videos at once
        location /api/videos {
            limit_req zone=api burst=60 nodelay;
            limit_req_status 429;
            proxy_pass http://go_backend;
            proxy_cache api_cache;
            proxy_cache_valid 200 5s;
            add_header X-Cache-Status $upstream_cache_status always;
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept, X-User-ID" always;
            add_header Access-Control-Expose-Headers "X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset" always;
            add_header Access-Control-Max-Age 86400 always;
        }

        # --- Database export: strict rate limit ---
        location /api/database/ {
            limit_req zone=export burst=1 nodelay;
            limit_req_status 429;
            proxy_pass http://go_backend;
        }

        # --- All other API routes -> Go backend ---
        location /api/ {
            limit_req zone=api burst=20 nodelay;
            limit_req_status 429;
            proxy_pass http://go_backend;
        }

        # --- Python backend (available on /py/ prefix for testing/comparison) ---
        location /py/api/ {
            rewrite ^/py(.*)$ $1 break;
            proxy_pass http://python_backend;
        }

        location /py/health/ {
            rewrite ^/py(.*)$ $1 break;
            proxy_pass http://python_backend;
        }

        # --- Default: 404 ---
        location / {
            return 404 '{"error":{"code":"NOT_FOUND","message":"Not found"}}';
            default_type application/json;
        }
    }
}
